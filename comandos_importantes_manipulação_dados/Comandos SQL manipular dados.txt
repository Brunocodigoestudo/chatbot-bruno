Comandos SQL para filtrar dados

-- Nome do contato que começa com "A"
SELECT * FROM customers
WHERE contact_name LIKE 'A%';

-- localizado na "Alemanha", "França" ou "Reino Unido":
SELECT * FROM customers
WHERE country IN ('Germany', 'France', 'UK');

-- Exemplo com BETWEEN, localizado entre 10 e 20
SELECT * FROM products
WHERE unit_price BETWEEN 10 AND 20;

-- Utiliza OR para mais de uma cidade
SELECT * from customers
WHERE city = 'Berlin' or city ='London';

-- Faz uma contagem de quantos países distintos existem
SELECT count(DISTINCT country) from customers;

-- Exibe os países distintos
SELECT DISTINCT country from customers

-- Utiliza AND para múltiplos critérios
SELECT * from  customers
WHERE city = 'Mannheim' and  address = 'Forsterstr. 57';

-- Calculos matemáticos

-- Exemplo de MIN()
SELECT MIN(unit_price) AS preco_minimo
FROM products;

-- Exemplo de MAX()
SELECT MAX(unit_price) AS preco_maximo
FROM products;

-- Exemplo de COUNT()
SELECT COUNT(*) AS total_de_produtos
FROM products;

-- Exemplo de AVG()
SELECT AVG(unit_price) AS preco_medio
FROM products;

-- Exemplo de SUM()
SELECT SUM(quantity) AS quantidade_total_de_order_details
FROM order_details;


-- Exemplo de GROUP BY e ORDER BY com decrescente
SELECT product_id,
	max(unit_price) as preço_maximo_unit
from 
	products
GROUP BY product_id
ORDER by  product_id desc


-- Exemplo de LEFT JOIN com ORDER BY (LEFT JOIN traz todos os registros da tabela da esquerda,
-- mesmo se não houver correspondência na tabela da direita)

SELECT
	c.customer_id
	,c.contact_name
	,o.order_date
	,o.required_date
FROM customers c
LEFT join orders o ON o.customer_id = c.customer_id
ORDER BY contact_name ASC

-- Comandos SQL para ver o tamanho de tabelas
select 
pg_size_pretty(pg_table_size('categories'))

-- Comandos para criar KPI
SELECT order_id,
       COUNT(order_id) AS unique_product,
       SUM(quantity) AS total_quantity,
       SUM(unit_price * quantity) AS total_price
FROM order_details
GROUP BY order_id
ORDER BY order_id;

-- Formas de agrupar sem GROUP BY e saber com EXPLAIN ANALYSE 
-- qual o custo de processamento que acontece no banco
EXPLAIN ANALYSE

SELECT DISTINCT customer_id,
   MIN(freight) OVER (PARTITION BY customer_id) AS min_freight,
   MAX(freight) OVER (PARTITION BY customer_id) AS max_freight,
   AVG(freight) OVER (PARTITION BY customer_id) AS avg_freight
FROM orders
ORDER BY customer_id;


-- Agrupamneto por contagem de conversas

SELECT
    COUNT(DISTINCT c.sdffef) AS total_conversas,
    COUNT(c.conversationid) AS total_interações,
    EXTRACT(MONTH FROM c.data_criacao) AS mes,
    EXTRACT(YEAR FROM c.data_criacao) AS ano
FROM conversa c
LEFT JOIN agente a ON a.reyetyy_id_trtt = c.rwtrwywry_id
WHERE a.nqerre = 'rertwtwt'
GROUP BY 
    EXTRACT(YEAR FROM c.data_criacao),
    EXTRACT(MONTH FROM c.data_criacao)
ORDER BY 
    mes,
    ano;

